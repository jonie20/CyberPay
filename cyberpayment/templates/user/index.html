{% extends 'user/base.html' %}
{% load static %}
{% block content %}
	<body class="app">   	
    <header class="app-header fixed-top">	   	            
        {% include 'v1/topbar.html' %}
        <div id="app-sidepanel" class="app-sidepanel"> 
	        <div id="sidepanel-drop" class="sidepanel-drop"></div>
	        <div class="sidepanel-inner d-flex flex-column">
		        <a href="#" id="sidepanel-close" class="sidepanel-close d-xl-none">&times;</a>
		        <div class="app-branding">
		            <a class="app-logo" href="index.html"><img class="logo-icon me-2" src="{% static 'images/background/img.png'%}" alt="logo"><span class="logo-text">ELMS</span></a>
	
		        </div><!--//app-branding-->  
		        
			    <nav id="app-nav-main" class="app-nav app-nav-main flex-grow-1">
				    <ul class="app-menu list-unstyled accordion" id="menu-accordion">
					    <li class="nav-item">
					        <!--//Bootstrap Icons: https://icons.getbootstrap.com/ -->
					        <a class="nav-link active" href="index.html">
						        <span class="nav-icon">
						        <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-house-door" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
		  <path fill-rule="evenodd" d="M7.646 1.146a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 .146.354v7a.5.5 0 0 1-.5.5H9.5a.5.5 0 0 1-.5-.5v-4H7v4a.5.5 0 0 1-.5.5H2a.5.5 0 0 1-.5-.5v-7a.5.5 0 0 1 .146-.354l6-6zM2.5 7.707V14H6v-4a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4h3.5V7.707L8 2.207l-5.5 5.5z"/>
		  <path fill-rule="evenodd" d="M13 2.5V6l-2-2V2.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5z"/>
		</svg>
						         </span>
		                         <span class="nav-link-text">Overview</span>
					        </a><!--//nav-link-->
					    </li><!--//nav-item-->
					    <li class="nav-item has-submenu">
					        <!--//Bootstrap Icons: https://icons.getbootstrap.com/ -->
					        <a class="nav-link submenu-toggle" href="#" data-bs-toggle="collapse" data-bs-target="#submenu-1" aria-expanded="false" aria-controls="submenu-1">
						        <span class="nav-icon">
						        <!--//Bootstrap Icons: https://icons.getbootstrap.com/ -->
						        <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-files" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
	  <path fill-rule="evenodd" d="M4 2h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm0 1a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h7a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1H4z"/>
	  <path d="M6 0h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2v-1a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6a1 1 0 0 0-1 1H4a2 2 0 0 1 2-2z"/>
	</svg>
						         </span>
		                         <span class="nav-link-text">Leave</span>
		                         <span class="submenu-arrow">
		                             <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-chevron-down" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
	  <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
	</svg>
	                             </span><!--//submenu-arrow-->
					        </a><!--//nav-link-->
					        <div id="submenu-1" class="collapse submenu submenu-1" data-bs-parent="#menu-accordion">
						        <ul class="submenu-list list-unstyled">
							        <li class="submenu-item"><a class="submenu-link" href="apply_leave.html">Apply Leave</a></li>
							        <li class="submenu-item"><a class="submenu-link" href="{% url 'payment_history' %}">Payment History</a></li>
						        </ul>
					        </div>
					    </li><!--//nav-item-->
				    </ul><!--//app-menu-->
			    </nav><!--//app-nav-->
			    <div class="app-sidepanel-footer">
				    <nav class="app-nav app-nav-footer">
					    <ul class="app-menu footer-menu list-unstyled">
						    <li class="nav-item">
						        <!--//Bootstrap Icons: https://icons.getbootstrap.com/ -->
						        <a class="nav-link" href="settings.html">
							        <span class="nav-icon">
							            <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-gear" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
	  <path fill-rule="evenodd" d="M8.837 1.626c-.246-.835-1.428-.835-1.674 0l-.094.319A1.873 1.873 0 0 1 4.377 3.06l-.292-.16c-.764-.415-1.6.42-1.184 1.185l.159.292a1.873 1.873 0 0 1-1.115 2.692l-.319.094c-.835.246-.835 1.428 0 1.674l.319.094a1.873 1.873 0 0 1 1.115 2.693l-.16.291c-.415.764.42 1.6 1.185 1.184l.292-.159a1.873 1.873 0 0 1 2.692 1.116l.094.318c.246.835 1.428.835 1.674 0l.094-.319a1.873 1.873 0 0 1 2.693-1.115l.291.16c.764.415 1.6-.42 1.184-1.185l-.159-.291a1.873 1.873 0 0 1 1.116-2.693l.318-.094c.835-.246.835-1.428 0-1.674l-.319-.094a1.873 1.873 0 0 1-1.115-2.692l.16-.292c.415-.764-.42-1.6-1.185-1.184l-.291.159A1.873 1.873 0 0 1 8.93 1.945l-.094-.319zm-2.633-.283c.527-1.79 3.065-1.79 3.592 0l.094.319a.873.873 0 0 0 1.255.52l.292-.16c1.64-.892 3.434.901 2.54 2.541l-.159.292a.873.873 0 0 0 .52 1.255l.319.094c1.79.527 1.79 3.065 0 3.592l-.319.094a.873.873 0 0 0-.52 1.255l.16.292c.893 1.64-.902 3.434-2.541 2.54l-.292-.159a.873.873 0 0 0-1.255.52l-.094.319c-.527 1.79-3.065 1.79-3.592 0l-.094-.319a.873.873 0 0 0-1.255-.52l-.292.16c-1.64.893-3.433-.902-2.54-2.541l.159-.292a.873.873 0 0 0-.52-1.255l-.319-.094c-1.79-.527-1.79-3.065 0-3.592l.319-.094a.873.873 0 0 0 .52-1.255l-.16-.292c-.892-1.64.902-3.433 2.541-2.54l.292.159a.873.873 0 0 0 1.255-.52l.094-.319z"/>
	  <path fill-rule="evenodd" d="M8 5.754a2.246 2.246 0 1 0 0 4.492 2.246 2.246 0 0 0 0-4.492zM4.754 8a3.246 3.246 0 1 1 6.492 0 3.246 3.246 0 0 1-6.492 0z"/>
	</svg>
							        </span>
			                        <span class="nav-link-text">Settings</span>
						        </a><!--//nav-link-->
						    </li><!--//nav-item-->
						    <li class="nav-item">
						        <!--//Bootstrap Icons: https://icons.getbootstrap.com/ -->
						        <a class="nav-link" href="https://themes.3rdwavemedia.com/bootstrap-templates/admin-dashboard/portal-free-bootstrap-admin-dashboard-template-for-developers/">
							        <span class="nav-icon">
							            <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-download" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
	  <path fill-rule="evenodd" d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
	  <path fill-rule="evenodd" d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
	</svg>
							        </span>
			                        <span class="nav-link-text">Download</span>
						        </a><!--//nav-link-->
						    </li><!--//nav-item-->
						    <li class="nav-item">
						        <!--//Bootstrap Icons: https://icons.getbootstrap.com/ -->
						        <a class="nav-link" href="https://themes.3rdwavemedia.com/bootstrap-templates/admin-dashboard/portal-free-bootstrap-admin-dashboard-template-for-developers/">
							        <span class="nav-icon">
							            <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-file-person" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
	  <path fill-rule="evenodd" d="M12 1H4a1 1 0 0 0-1 1v10.755S4 11 8 11s5 1.755 5 1.755V2a1 1 0 0 0-1-1zM4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H4z"/>
	  <path fill-rule="evenodd" d="M8 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
	</svg>
							        </span>
			                        <span class="nav-link-text">License</span>
						        </a><!--//nav-link-->
						    </li><!--//nav-item-->
					    </ul><!--//footer-menu-->
				    </nav>
			    </div><!--//app-sidepanel-footer-->
		       
	        </div><!--//sidepanel-inner-->
	    </div><!--//app-sidepanel-->
    </header><!--//app-header-->
    
    <div class="app-wrapper">
	    
	    <div class="app-content pt-3 p-md-3 p-lg-4">
		    <div class="container-xl">
			    
			    <h1 class="app-page-title">Overview</h1>
				    
			    <div class="row g-4 mb-4">
				    <div class="col-6 col-lg-3">
					    <div class="app-card app-card-stat shadow-sm h-100">
						    <div class="app-card-body p-3 p-lg-4">
							    <h4 class="stats-type mb-1">Total Customers</h4>
							    <div class="stats-figure">628</div>
						    </div><!--//app-card-body-->
						    <a class="app-card-link-mask" href="#"></a>
					    </div><!--//app-card-->
				    </div><!--//col-->
				    
				    <div class="col-6 col-lg-3">
					    <div class="app-card app-card-stat shadow-sm h-100">
						    <div class="app-card-body p-3 p-lg-4">
							    <h4 class="stats-type mb-1">Today's Earnings</h4>
							    <div class="stats-figure">250</div>
						    </div><!--//app-card-body-->
						    <a class="app-card-link-mask" href="#"></a>
					    </div><!--//app-card-->
				    </div><!--//col-->
				    <div class="col-6 col-lg-3">
					    <div class="app-card app-card-stat shadow-sm h-100">
						    <div class="app-card-body p-3 p-lg-4">
							    <h4 class="stats-type mb-1">Total Services</h4>
							    <div class="stats-figure">23</div>
							    <div class="stats-meta">
								    Open</div>
						    </div><!--//app-card-body-->
						    <a class="app-card-link-mask" href="#"></a>
					    </div><!--//app-card-->
				    </div><!--//col-->
				    <div class="col-6 col-lg-3">
					    <div class="app-card app-card-stat shadow-sm h-100">
						    <div class="app-card-body p-3 p-lg-4">
							    <h4 class="stats-type mb-1">Staff</h4>
							    <div class="stats-figure">6</div>
							    <div class="stats-meta">New</div>
						    </div><!--//app-card-body-->
						    <a class="app-card-link-mask" href="#"></a>
					    </div><!--//app-card-->
				    </div><!--//col-->
			    </div><!--//row-->

				<div class="container-xl">
					
					<div class="row g-3 mb-4 align-items-center justify-content-between">
						<div class="col-auto">
							<h1 class="app-page-title mb-0">Payment for Service</h1>
						</div>
						<div class="col-auto">
							 <div class="page-utilities">
								<div class="row g-2 justify-content-start justify-content-md-end align-items-center">
									<div class="col-auto">
										<form class="table-search-form row gx-1 align-items-center">
											<div class="col-auto">
												<input type="text" id="search-orders" name="searchorders" class="form-control search-orders" placeholder="Search">
											</div>
											<div class="col-auto">
												<button type="submit" class="btn app-btn-secondary">Search</button>
											</div>
										</form>
										
									</div><!--//col-->
									<div class="col-auto">
										
										<select class="form-select w-auto" >
											  <option selected value="option-1">All</option>
											  <option value="option-2">This week</option>
											  <option value="option-3">This month</option>
											  <option value="option-4">Last 3 months</option>
											  
										</select>
									</div>
									<div class="col-auto">						    
										<a class="btn app-btn-secondary" href="#">
											<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-download me-1" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
			  <path fill-rule="evenodd" d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
			  <path fill-rule="evenodd" d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
			</svg>
											Download CSV
										</a>
									</div>
								</div><!--//row-->
							</div><!--//table-utilities-->
						</div><!--//col-auto-->
					</div><!--//row-->					
					
					<div class="tab-content" id="orders-table-tab-content">


						<div class="tab-pane active" id="orders-all" role="tabpanel" aria-labelledby="orders-all-tab">
							<div class="app-card app-card-orders-table shadow-sm mb-5">
								<div class="app-card-body">
									<div class="table-responsive">
										<table class="table app-table-hover mb-0 text-left">
											<thead>
												<tr>
													<th class="cell">s/no</th>
													<th class="cell">Service/Name</th>
													<th class="cell">Description</th>
													<th class="cell">Charges</th>
													<th class="cell"></th>
												</tr>
											</thead>
											<tbody>
												{% if servic %}
												{% for s in servic %}
												<tr>
													<td class="cell">{{ forloop.counter }}</td>
													<td class="cell">{{ s.name}}</td>
													<td class="cell"><span class="truncate">{{s.description}}</span></td>
													<td class="cell">Ksh. {{ s.cost}}</td>
													<td class="cell"><button type="button" class="btn app-btn-primary"
														data-id="{{ s.id }}"
														data-service="{{ s.name }}"
														data-cost="{{ s.cost }}"
														data-bs-toggle="modal" data-bs-target="#staticBackdrop">
														Pay for Service</button></td>
												</tr>
												{% endfor %}
                                                {% else %}
												<tr>
                                                    <td colspan="7" class="text-center">No services</td>
                                                </tr>
												{% endif %}
			
											</tbody>
										</table>
									</div><!--//table-responsive-->
								   
								</div><!--//app-card-body-->		
							</div><!--//app-card-->
							<nav class="app-pagination">
								<ul class="pagination justify-content-center">
									<li class="page-item disabled">
										<a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
									</li>
									<li class="page-item active"><a class="page-link" href="#">1</a></li>
									<li class="page-item"><a class="page-link" href="#">2</a></li>
									<li class="page-item"><a class="page-link" href="#">3</a></li>
									<li class="page-item">
										<a class="page-link" href="#">Next</a>
									</li>
								</ul>
							</nav><!--//app-pagination-->
							
						</div><!--//tab-pane-->
					</div><!--//tab-content-->
					
					
					
				</div><!--//container-fluid-->				
			    
		    </div><!--//container-fluid-->
	    </div><!--//app-content-->

		
		<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="exampleModalLabel">Payment Information</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<div class="app-card app-card-settings shadow-sm p-4">
							<div class="app-card-body">
								<span id="statusspinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none"></span><div id="responseMessage" class="mt-3"></div>
								<form id="stkPushForm" class="settings-form">
									{% csrf_token %}
									<div class="mb-3">
										<label for="customerName" class="form-label">
											Customer Name
											<span class="ms-2" data-bs-container="body" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-placement="top" data-bs-content="Enter your full name for reference.">
												<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-info-circle" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
													<path fill-rule="evenodd" d="M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
													<path d="M8.93 6.588l-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588z"/>
													<circle cx="8" cy="4.5" r="1"/>
												</svg>
											</span>
										</label>
										<input type="text" class="form-control" name="name" id="customerName" placeholder="John Doe" required>
									</div>
									<div class="mb-3">
										<input type="hidden" name="text" id="userId">
									</div>
									<div class="mb-3">
										<label for="phoneNumber" class="form-label">Service </label>
										
										<input type="text" class="form-control" id="serviceName" readonly required>
									</div>
		
									<div class="mb-3">
										<label for="phoneNumber" class="form-label">Phone Number</label>
										
										<input type="text" class="form-control" name="phone" id="phoneNumber" placeholder="2547XXXXXXXX" required>
									</div>
		
									<div class="mb-3">
										<label for="amount" class="form-label">Amount</label>
										<input type="number" class="form-control" name="amount" id="amount" placeholder="Enter amount" readonly required>
									</div>
		
									<button type="submit" class="btn app-btn-primary" id="submitButton"><span id="spinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none"></span><span id="buttonText">Pay Now</span></button>
								</form>
		
								
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

	    
	    <footer class="app-footer">
		    <div class="container text-center py-3">
		         <!--/* This template is free as long as you keep the footer attribution link. If you'd like to use the template without the attribution link, you can buy the commercial license via our website: themes.3rdwavemedia.com Thank you for your support. :) */-->
            <small class="copyright">Designed with <span class="sr-only">love</span><i class="fas fa-heart" style="color: #fb866a;"></i> by <a class="app-link" href="http://themes.3rdwavemedia.com" target="_blank">Nandi Developers</a> for developers</small>
		       
		    </div>
	    </footer><!--//app-footer-->
	    
    </div><!--//app-wrapper--> 
	
	<!-- JavaScript to Handle STK Push via AJAX -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
//   // Function to retrieve Service details
const staticBackdropModal = document.getElementById('staticBackdrop');
staticBackdropModal.addEventListener('show.bs.modal', function (event) {
  // Button that triggered the modal
  const button = event.relatedTarget;
  const userId = button.getAttribute('data-id');
  const serviceName = button.getAttribute('data-service');
  const cost = button.getAttribute('data-cost');

  document.getElementById('userId').value = userId;
  document.getElementById('serviceName').value = serviceName;
  document.getElementById('amount').value = cost;
});

document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("stkPushForm");
    const submitButton = document.getElementById("submitButton");
    const buttonText = document.getElementById("buttonText");
    const spinner = document.getElementById("spinner");
    const statusContainer = document.getElementById("status-container");
    const loadingSpinner = document.getElementById("loading-spinner");
    const statusMessage = document.getElementById("status-message");
    const retryButton = document.getElementById("retry-button");
    const initialMessage = document.getElementById("initial-message");
    const confirmText = document.getElementById("confirm-text");
    let checkoutRequestID = null;
    let reqcount = 0;
    const maxAttempts = 60;

    // Function to handle form submission
    form.addEventListener("submit", function (event) {
      event.preventDefault(); // Prevent default form submission

      // Update button UI
      buttonText.textContent = "Processing...";
      spinner.style.display = "inline-block";
      submitButton.disabled = true;

      // Extract form data
      const formData = new FormData(form);
      // Perform AJAX request to send STK push request

      fetch("{% url 'payment' %}", {
        method: "POST",
        body: formData,
      })
      .then(response => response.json())
      .then(data => {
		console.log("Received CheckoutRequestID:", data.CheckoutRequestID);

        if (data.ResponseCode === "0") {
          checkoutRequestID = data.CheckoutRequestID;
		//   document.getElementById("statusspinner").style.display = "none";
          document.getElementById("responseMessage").innerHTML =
            '<div class="alert alert-success">STK Push sent. Check your phone.</div>';
          
          // Start polling for payment status
          stkPushQueryWithIntervals(checkoutRequestID);
        } else {
          document.getElementById("responseMessage").innerHTML =
            '<div class="alert alert-danger">Error: ' + data.errorMessage + '</div>';
        }
      })
      .catch(() => {
        document.getElementById("responseMessage").innerHTML =
          '<div class="alert alert-danger">An error occurred. Try again.</div>';
      })
      .finally(() => {
        // Reset button UI after response
        buttonText.textContent = "Pay Now";
        spinner.style.display = "none";
        submitButton.disabled = false;
      });
    });

    // Function to track STK push status
    const stkPushQueryWithIntervals = (checkoutRequestID) => {
      const timer = setInterval(async () => {
        reqcount += 1;

        try {
		console.log("Fetching STK status...")
          const response = await fetch("/stk-status/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{ csrf_token }}",
            },
            body: JSON.stringify({ checkout_request_id: checkoutRequestID }),
          });

          if (!response.ok) throw new Error("Failed to fetch status");

          const data = await response.json();
          console.log("STK Query Response:", data);

          const resultCode = data.status.ResultCode;
          const resultDesc = data.status.ResultDesc || "Payment failed. Please try again.";

          if (data.status.errorCode === "500.001.1001") {
            console.log("Payment is still being processed...");
          } else if (resultCode === "0") {
            clearInterval(timer);
			document.getElementById("loading-spinner").style.display = "none";
            document.getElementById("responseMessage").innerHTML = `Payment successful <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-x-circle-fill text-danger m-2" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8 7.293z"/></svg>`;
            confirmText.style.display = "none";
            initialMessage.innerHTML = `Payment successful <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="#006039" class="bi bi-check-circle m-2" viewBox="0 0 16 16">
                      <path d="M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14zm3.97-8.03a.75.75 0 0 1 0 1.06l-4 4a.75.75 0 0 1-1.06 0l-2-2a.75.75 0 0 1 1.06-1.06L7.5 10.94l3.47-3.47a.75.75 0 0 1 1.06 0z"/>
                    </svg>`;
            statusMessage.innerHTML = `
                  <div class="text-success">
                   <p class="mt-2">Thank you for completing your payment!</p>
                    <a href="{% url 'payment' %}" class="btn btn-success">Ok</a>
                  </div>
                `;
            confettiEffect(); // Trigger confetti on success
          } else if (resultCode) {
            clearInterval(timer);
            // document.getElementById("loading-spinner").style.display = "none";
			document.getElementById("responseMessage").innerHTML =`
			<div class="alert alert-danger">Payment failed.<p class="mt-2">${resultDesc}</p></div>
			`;
 
            document.getElementById("retry-button").style.display = "inline-block";
          }
        } catch (error) {
          console.error("Error:", error);
        }

        if (reqcount >= maxAttempts) {
          clearInterval(timer);
          loadingSpinner.style.display = "none";
          statusMessage.innerHTML = `
                <div class="alert alert-warning" role="alert">
                  You took too long to confirm the payment. Please try again.
                </div>
              `;
          retryButton.style.display = "inline-block";
        }
      }, 2000);
    };

    retryButton.addEventListener("click", () => {
      reqcount = 0;
      retryButton.style.display = "none";
      loadingSpinner.style.display = "inline-block";
      statusMessage.textContent = "Waiting for confirmation...";
      stkPushQueryWithIntervals(checkoutRequestID);
    });
  });
</script>

{% endblock %}
{% block title %} home {% endblock %}